<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8" />
  <title>ã‚¹ãƒ†ãƒ¼ã‚¸4ï¼šã†ã•ã¡ã‚ƒã‚“ãŠå®¶ã¸å¸°ã‚‹</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link href="https://fonts.googleapis.com/css2?family=Yomogi&display=swap" rel="stylesheet">
  <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}">
  <style>
    #game-wrapper {/*ã‚²ãƒ¼ãƒ å…¨ä½“ã®ä¸Šã®ä½™ç™½ã‚’èª¿æ•´*/
      /*ã“ã“ã ã‘ä¸Šã«æ–‡ç« ãŒã‚ã‚‹ã®ã§ç„¡ç†ã‚„ã‚Šä¸Šæ›¸ã*/
      margin-top: 20px;
    }

    #instructions {/*èª¬æ˜æ–‡ã®ã‚¹ã‚¿ã‚¤ãƒ«*/
      text-align: center;
      font-size: 18px;
      font-weight: bold;
      margin-top: 10px;
    }

    canvas {
      display: block;
      margin: 0 auto;
      border: none;
      cursor: grab; /*ãƒ‰ãƒ©ãƒƒã‚°å¯èƒ½ãªã€Œæ‰‹ã€ã‚«ãƒ¼ã‚½ãƒ«(ãƒ‘ãƒ¼ã®æ‰‹)*/
    }

    canvas.dragging {
      cursor: grabbing;/*ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®ã€Œæ¡ã£ãŸæ‰‹ã€ã‚«ãƒ¼ã‚½ãƒ«(ã‚°ãƒ¼ã®æ‰‹)*/
    }
  </style>
</head>

<body>
  <h1>ã†ã•ã¡ã‚ƒã‚“ãŠå®¶ã¸å¸°ã‚‹</h1>
  <div id="instructions">é“ã‹ã‚‰ã¯ã¿å‡ºã•ãšã«ã†ã•ã¡ã‚ƒã‚“ã‚’ãŠå®¶ã¾ã§ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ãã ã•ã„ï¼ˆé›¢ã•ãªã„ã§ã­ğŸ°ï¼‰</div>
  <div id="game-wrapper">
    <canvas id="gameCanvas" width="800" height="600"></canvas>
  </div>
<script>
  const canvas = document.getElementById('gameCanvas');
  const ctx = canvas.getContext('2d');//ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’å–å¾—ã—ã€2Dæç”»ã§ãã‚‹ã‚ˆã†ã«è¨­å®š

  //é“ãƒ»å®¶ãƒ»ã†ã•ã¡ã‚ƒã‚“ã®ç”»åƒã‚’ä½œæˆ
  const michiImg = new Image();
  const houseImg = new Image();
  const usagiImg = new Image();
  const audio = new Audio("{{ url_for('static', filename='sounds/tokotoko.wav') }}"); //éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿
  audio.volume = 0.3;

  let soundInterval = null; //éŸ³å†ç”Ÿç”¨ã®ã‚¿ã‚¤ãƒãƒ¼ID

  //å„ç”»åƒã®ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’è¨­å®š
  michiImg.src = "{{ url_for('static', filename='images/michi.png') }}";
  houseImg.src = "{{ url_for('static', filename='images/house.png') }}";
  usagiImg.src = "{{ url_for('static', filename='images/usagi.png') }}";

  //ç”»åƒ3æšã™ã¹ã¦ãŒèª­ã¿è¾¼ã¾ã‚ŒãŸã‚‰ã‚²ãƒ¼ãƒ ã‚’åˆæœŸåŒ–(ã™ã¹ã¦ã®ç´ æãŒãã‚ã£ã¦ã‹ã‚‰ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ã™ã‚‹ãŸã‚ã®å®‰å…¨ãªä»•çµ„ã¿)
  let imagesLoaded = 0;//èª­ã¿è¾¼ã¾ã‚ŒãŸç”»åƒã®æ•°ã‚’æ•°ãˆã‚‹å¤‰æ•°ã§ã™æœ€åˆã¯0ã§ã‚¹ã‚¿ãƒ¼ãƒˆ
  function onImageLoad() {
    imagesLoaded++;//ç”»åƒãŒ1æšèª­ã¿è¾¼ã¾ã‚Œã‚‹ãŸã³ã«imagesLoadedã‚’1å¢—ã‚„ã™
    if (imagesLoaded === 3) {
      initGame();//3æšã™ã¹ã¦ã®ç”»åƒãŒèª­ã¿è¾¼ã¾ã‚ŒãŸã‚‰ã€ã‚²ãƒ¼ãƒ ã‚’åˆæœŸåŒ–ã™ã‚‹initGame()ã‚’å‘¼ã¶
    }//ã“ã‚Œã«ã‚ˆã‚Šç”»åƒãŒã¾ã è¡¨ç¤ºã§ããªã„çŠ¶æ…‹ã§ã‚²ãƒ¼ãƒ ãŒå§‹ã¾ã£ã¦ã—ã¾ã†ã®ã‚’é˜²ã
  }

  //ç”»åƒã®èª­ã¿è¾¼ã¿ãŒå®Œäº†ã—ãŸã‚‰onImageLoadã‚’å‘¼ã¶
  michiImg.onload = onImageLoad;
  houseImg.onload = onImageLoad;
  usagiImg.onload = onImageLoad;

  //ã†ã•ã¡ã‚ƒã‚“ã¨ãŠå®¶ã®ä½ç½®ã¨ã‚µã‚¤ã‚ºã‚’è¨­å®š
  let usagiX = 710;
  let usagiY = 520;
  const usagiSize = 48;
  const houseX = 20;
  const houseY = 20;
  const houseWidth = 100;
  const houseHeight = 100;

  //ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã‹ã©ã†ã‹ãƒã‚¦ã‚¹ã¨ã®ã‚ºãƒ¬é“ã®ãƒ”ã‚¯ã‚»ãƒ«æƒ…å ±
  let dragging = false;//ã†ã•ã¡ã‚ƒã‚“ã‚’ä»Šãƒ‰ãƒ©ãƒƒã‚°ä¸­ã‹ã©ã†ã‹ã‚’è¡¨ã™ãƒ•ãƒ©ã‚°(trueã«ãªã‚‹ã®ã¯ãƒã‚¦ã‚¹ã§ã†ã•ã¡ã‚ƒã‚“ã‚’ã¤ã‹ã‚“ã ã¨ã)
  let offsetX, offsetY;//ãƒã‚¦ã‚¹ã§ã†ã•ã¡ã‚ƒã‚“ã‚’ã¤ã‹ã‚“ã ã¨ãã®ãšã‚Œã‚’è¦šãˆã¦ãŠãå¤‰æ•°(ã†ã•ã¡ã‚ƒã‚“ã®é ­ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‰é ­ã‹ã‚‰ãšã£ã¨ãƒ‰ãƒ©ãƒƒã‚°ã•ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã«å¿…è¦)
  let pathPixels;//é“ã®ç”»åƒã®ä¸­èº«ã®ãƒ”ã‚¯ã‚»ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ã“ã“ã«ä¿å­˜(ã†ã•ã¡ã‚ƒã‚“ãŒé“ã‹ã‚‰ã¯ã¿å‡ºã—ã¦ã„ãªã„ã‹ï¼Ÿã‚’ãƒã‚§ãƒƒã‚¯)

  //ã‚²ãƒ¼ãƒ åˆæœŸåŒ–(é“ã‚’æã„ã¦ãƒ”ã‚¯ã‚»ãƒ«æƒ…å ±ã‚’å–å¾—ã—ã‚²ãƒ¼ãƒ é–‹å§‹)
  function initGame() {//initGameã¨ã„ã†åå‰ã®é–¢æ•°ã‚’å®šç¾©(ã‚²ãƒ¼ãƒ é–‹å§‹æ™‚ã«æœ€åˆã«å‘¼ã³å‡ºã—ã¦ã‚²ãƒ¼ãƒ ç”»é¢ã‚’æº–å‚™)
    //ã‚­ãƒ£ãƒ³ãƒã‚¹(canvas)ã®æç”»ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ(ctx)ã«é“ã®ç”»åƒmichiImgã‚’æãã€‚
    //(0, 0)ã¯æãå§‹ã‚ã‚‹å·¦ä¸Šã®ä½ç½®ã€canvas.width,canvas.heightã¯ã‚­ãƒ£ãƒ³ãƒã‚¹ã„ã£ã±ã„ã«åºƒã’ã‚‹æŒ‡å®š
    ctx.drawImage(michiImg, 0, 0, canvas.width, canvas.height);
    //ä»Šæã„ãŸã‚­ãƒ£ãƒ³ãƒã‚¹ã®ç”»åƒãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦pathPixelså¤‰æ•°ã«ä¿å­˜(é“ãŒã©ã“ã«ã‚ã‚‹ã‹ã‚’ãƒ”ã‚¯ã‚»ãƒ«å˜ä½ã§å¾Œã‹ã‚‰åˆ¤å®š)
    pathPixels = ctx.getImageData(0, 0, canvas.width, canvas.height);
    drawScene();//ã‚­ãƒ£ãƒ³ãƒã‚¹ã®èƒŒæ™¯ã‚„å®¶ã®ç”»åƒãªã©ã‚²ãƒ¼ãƒ ã®åŸºæœ¬çš„ãªã‚·ãƒ¼ãƒ³å…¨ä½“ã‚’æç”»
    drawUsagi(usagiX, usagiY);//drawUsagié–¢æ•°ã‚’å‘¼ã‚“ã§ã†ã•ã¡ã‚ƒã‚“ã‚’æŒ‡å®šã—ãŸåº§æ¨™(usagiX, usagiY)ã«æç”»
  }

  //æç”»é–¢æ•°(èƒŒæ™¯ï¼ˆé“ã¨å®¶ï¼‰ã¨ã†ã•ã¡ã‚ƒã‚“ã‚’æã)
  function drawScene() {//ã‚²ãƒ¼ãƒ ç”»é¢å…¨ä½“ï¼ˆèƒŒæ™¯ã¨å®¶ï¼‰ã‚’æãç›´ã™å‡¦ç†
    //ã‚­ãƒ£ãƒ³ãƒã‚¹å…¨ä½“ã‚’ä¸€æ—¦åˆæœŸåŒ–(clearRectã¯æŒ‡å®šã—ãŸç¯„å›²ã‚’é€æ˜ã«)å‘½ä»¤ã§æ¯å›æãç›´ã™ãŸã‚ä»¥å‰æã„ãŸå†…å®¹ã‚’æ¶ˆã™
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    //é“ã®ç”»åƒ(michiImg)ã‚’ã‚­ãƒ£ãƒ³ãƒã‚¹ã„ã£ã±ã„ã«æç”»å·¦ä¸Š(0, 0)ã«è²¼ã‚Šä»˜ã‘ã¦ã‚­ãƒ£ãƒ³ãƒã‚¹å…¨ä½“ã«åºƒã’ã‚‹å½¢
    ctx.drawImage(michiImg, 0, 0, canvas.width, canvas.height);
    //å®¶ã®ç”»åƒ(houseImg)ã‚’æŒ‡å®šã—ãŸä½ç½®(houseX,houseY)ã¨å¤§ãã•(houseWidth,houseHeight)ã§æã(é“ã®ä¸Šã«å®¶ã‚’é‡ã­ã¦è¡¨ç¤ºã™ã‚‹å½¢)
    ctx.drawImage(houseImg, houseX, houseY, houseWidth, houseHeight);
  }

  function drawUsagi(x, y) {//ã†ã•ã¡ã‚ƒã‚“ã®ç”»åƒ(usagiImg)ã‚’åº§æ¨™(x, y)ã«æç”»ã™ã‚‹(å¹…ã¨é«˜ã•ã¯usagiSize48Ã—48pxè¡¨ç¤º)
    ctx.drawImage(usagiImg, x, y, usagiSize, usagiSize);
  }

  //é“ã®åˆ¤å®š
  function isOnPath(x, y) {//x, yã¨ã„ã†åº§æ¨™ãŒé“ã®ä¸Šã«ã‚ã‚‹ã‹ï¼Ÿã‚’åˆ¤å®šã™ã‚‹é–¢æ•°
    if (!pathPixels) return false;//pathPixelsãŒã¾ã èª­ã¿è¾¼ã¾ã‚Œã¦ã„ãªã„()=ç”»åƒã®ãƒ”ã‚¯ã‚»ãƒ«ãƒ‡ãƒ¼ã‚¿ãŒãªã„)å ´åˆã¯é“ã˜ã‚ƒãªã„ã¨åˆ¤å®šã—ã¦falseã‚’è¿”ã™
    const px = Math.floor(x);//x, yã¯å°æ•°(ãƒã‚¦ã‚¹åº§æ¨™)ã«ãªã£ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‚‹ã®ã§æ•´æ•°ã«ä¸¸ã‚ã¦ã‚­ãƒ£ãƒ³ãƒã‚¹ä¸Šã®ãƒ”ã‚¯ã‚»ãƒ«åº§æ¨™ã«å¤‰æ›
    const py = Math.floor(y);
    if (px < 0 || py < 0 || px >= canvas.width || py >= canvas.height) return false;//ã‚­ãƒ£ãƒ³ãƒã‚¹ã®å¤–ã‚’æŒ‡ã—ã¦ã„ãŸã‚‰é“ã˜ã‚ƒãªã„ã®ã§falseã‚’è¿”ã™
    if (//åº§æ¨™ãŒãŠã†ã¡ã®ã‚¨ãƒªã‚¢(å››è§’ã„ç¯„å›²)å†…ã«ã‚ã‚‹å ´åˆã¯ç‰¹åˆ¥ã«OKã¨ã¿ãªã—ã¦trueã‚’è¿”ã™(é“ã§ã¯ãªã„ã‘ã©ã‚´ãƒ¼ãƒ«ãªã®ã§ã‚»ãƒ¼ãƒ•)
      x >= houseX &&
      x <= houseX + houseWidth &&
      y >= houseY &&
      y <= houseY + houseHeight
    ) {
      return true;
    }
    const idx = (py * canvas.width + px) * 4;//ã‚­ãƒ£ãƒ³ãƒã‚¹ä¸Šã®(px, py)ã«ã‚ã‚‹pxã®ãƒ‡ãƒ¼ã‚¿ä½ç½®ã‚’è¨ˆç®—(1pxã‚ãŸã‚Š4ã¤ã®ãƒ‡ãƒ¼ã‚¿(R,G,B,A)ãªã®ã§* 4
    const r = pathPixels.data[idx];//æŒ‡å®šãƒ”ã‚¯ã‚»ãƒ«ã®RGBå€¤(èµ¤ãƒ»ç·‘ãƒ»é’)ã‚’å–ã‚Šå‡ºã™
    const g = pathPixels.data[idx + 1];
    const b = pathPixels.data[idx + 2];
    return (r >= 250 && g >= 250 && b >= 250);//ç™½ã£ã½ã„éƒ¨åˆ†ãŒé“(3ã¤ã®å€¤(r,g,b)ãŒå…¨éƒ¨250ä»¥ä¸Šã¤ã¾ã‚Šã»ã¼ç™½ã ã£ãŸã‚‰é“ã¨åˆ¤æ–­ã—ã¦trueã‚’è¿”ã™)
  }

  //éŸ³ã®ãƒ«ãƒ¼ãƒ—å‡¦ç†(éŸ³ã‚’ç¹°ã‚Šè¿”ã—å†ç”Ÿï¼†åœæ­¢ã™ã‚‹é–¢æ•°)
  function startSoundLoop() {//éŸ³ã‚’ç¹°ã‚Šè¿”ã—é³´ã‚‰ã™å‡¦ç†ã‚’é–‹å§‹ã™ã‚‹é–¢æ•°
    if (!soundInterval) {//ã™ã§ã«ç¹°ã‚Šè¿”ã—å‡¦ç†ãŒå§‹ã¾ã£ã¦ã„ã‚‹ã‹ã‚’ãƒã‚§ãƒƒã‚¯(äºŒé‡ã§å†ç”Ÿã—ãªã„ã‚ˆã†ã«)
      audio.play();//æœ€åˆã«ä¸€åº¦éŸ³ã‚’å†ç”Ÿ
      soundInterval = setInterval(() => {//setIntervalã®æˆ»ã‚Šå€¤(ç¹°ã‚Šè¿”ã—å‡¦ç†ã®ID)ã‚’soundIntervalã«ä¿å­˜
        audio.currentTime = 0;//éŸ³ã‚’å…ˆé ­ã‹ã‚‰å†ç”Ÿã—ç›´ã™
        audio.play();
      }, 500);//0.5ç§’(500ãƒŸãƒªç§’)ã”ã¨ã«éŸ³ã‚’å†ç”Ÿ
    }
  }

  function stopSoundLoop() {//éŸ³ã‚’æ­¢ã‚ã‚‹å‡¦ç†
    clearInterval(soundInterval);//setInterval()ã§é–‹å§‹ã—ãŸç¹°ã‚Šè¿”ã—å‡¦ç†(éŸ³ã‚’é³´ã‚‰ã™)ã‚’åœæ­¢
    soundInterval = null;//ä»Šã¯ç¹°ã‚Šè¿”ã—å‡¦ç†ãŒè¡Œã‚ã‚Œã¦ã„ãªã„çŠ¶æ…‹ã‚’ç¤ºã™ãŸã‚å¤‰æ•°ã‚’ãƒªã‚»ãƒƒãƒˆ(æ¬¡ã«startSoundLoop()ã‚’å‘¼ã‚“ã ã¨ãã«å†ã³éŸ³ã‚’é³´ã‚‰ã›ã‚‹ã‚ˆã†ã«)
  }

  //ãƒã‚¦ã‚¹æ“ä½œã‚¤ãƒ™ãƒ³ãƒˆ(ã†ã•ã¡ã‚ƒã‚“ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‰ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹)
  //ãƒã‚¦ã‚¹ã®ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸã¨ãã®å‡¦ç†ã‚’ç™»éŒ²("mousedown"ã¯æŠ¼ã—å§‹ã‚ã®ã‚¤ãƒ™ãƒ³ãƒˆ)eã¯ã‚¤ãƒ™ãƒ³ãƒˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ã©ã“ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‹ãªã©ã®æƒ…å ±ãŒå…¥ã£ã¦ã„ã‚‹
  canvas.addEventListener('mousedown', (e) => {
    const rect = canvas.getBoundingClientRect();//canvasè¦ç´ ã®ä½ç½®ã¨ã‚µã‚¤ã‚ºã‚’å–å¾—
    const mx = e.clientX - rect.left;//canvaså†…ã§ã®Xåº§æ¨™
    const my = e.clientY - rect.top;
    //ã†ã•ã¡ã‚ƒã‚“ç”»åƒã®ç¯„å›²å†…ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‹ã©ã†ã‹ã®åˆ¤å®š(ç”»åƒã®å·¦ä¸Šã‹ã‚‰å³ä¸‹ã¾ã§ã®ç¯„å›²ã«ãƒã‚¦ã‚¹åº§æ¨™ãŒå…¥ã£ã¦ã„ã‚Œã°true)
    if (mx >= usagiX && mx <= usagiX + usagiSize && my >= usagiY && my <= usagiY + usagiSize) {
      dragging = true;
      offsetX = mx - usagiX;//ãƒã‚¦ã‚¹ã®ä½ç½®ã¨ã†ã•ã¡ã‚ƒã‚“ç”»åƒã®ä½ç½®ã®å·®ã‚’è¨˜éŒ²(ã‚¯ãƒªãƒƒã‚¯ã—ãŸå ´æ‰€ã«åˆã‚ã›ã¦ã†ã•ã¡ã‚ƒã‚“ãŒè‡ªç„¶ã«å‹•ã)
      offsetY = my - usagiY;
      canvas.classList.add('dragging');//ã‚°ãƒ¼ã®æ‰‹ã«å¤‰ãˆã‚‹
      startSoundLoop(); //ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹æ™‚ã«éŸ³å†ç”Ÿé–‹å§‹
    }
  });

  //ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã«é“ã‹ã‚‰ã¯ã¿å‡ºã—ãŸã‚‰ã‚„ã‚Šç›´ã—(/continue ã«ç§»å‹•ï¼‰
  canvas.addEventListener('mousemove', (e) => {//ãƒã‚¦ã‚¹ãŒå‹•ã„ãŸã¨ãã«å‘¼ã°ã‚Œã‚‹å‡¦ç†ã‚’ç™»éŒ²(eã¯ãƒã‚¦ã‚¹ã®ä½ç½®ãªã©ãŒå…¥ã£ã¦ã„ã‚‹)
    if (!dragging) return;//ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã§ãªã‘ã‚Œã°ä½•ã‚‚ã—ãªã„
    const rect = canvas.getBoundingClientRect();//canvasã®ç”»é¢ä¸Šã®ä½ç½®ã‚„å¤§ãã•ã‚’å–å¾—
    const mx = e.clientX - rect.left;//canvaså†…ã§ã®ãƒã‚¦ã‚¹ä½ç½®ã‚’è¨ˆç®—
    const my = e.clientY - rect.top;//ã†ã•ã¡ã‚ƒã‚“ã®ä¸­å¿ƒåº§æ¨™(ãƒã‚¦ã‚¹åº§æ¨™ã‚’åŸºæº–ã«è£œæ­£)ã‚’è¨ˆç®—
    let newX = mx - offsetX + usagiSize / 2;
    let newY = my - offsetY + usagiSize / 2;

    if (!isOnPath(newX, newY)) {//ã†ã•ã¡ã‚ƒã‚“ã®ä¸­å¿ƒãŒé“(ç™½ã„éƒ¨åˆ†)ã«ä¹—ã£ã¦ã„ã‚‹ã‹ï¼Ÿã‚’åˆ¤å®š
      dragging = false;//é“ã‹ã‚‰å¤–ã‚Œã¦ã„ãŸã‚‰ãƒ‰ãƒ©ãƒƒã‚°çµ‚äº†
      canvas.classList.remove('dragging');//CSSã®draggingã‚¯ãƒ©ã‚¹ã‚’å¤–ã—ã¦ã‚«ãƒ¼ã‚½ãƒ«ã‚’å…ƒã«æˆ»ã™(ã‚°ãƒ¼ã‹ã‚‰ãƒ‘ãƒ¼ã«)
      stopSoundLoop(); //é›¢ã‚ŒãŸã‚‰éŸ³åœæ­¢
      window.location.href = "/continue";//é“ã‹ã‚‰å¤–ã‚ŒãŸãŸã‚ã‚²ãƒ¼ãƒ ã®continueç”»é¢ã¸è‡ªå‹•çš„ã«é·ç§»
      return;//ã“ã“ã§å‡¦ç†ã‚’çµ‚ã‚ã‚‰ã›ã‚‹(é“å¤–ã‚Œã®å ´åˆã¯ä»¥é™ã®å‡¦ç†ã‚’ã—ãªã„)
    }

    usagiX = mx - offsetX;//é“ã‹ã‚‰å¤–ã‚Œã¦ã„ãªã‘ã‚Œã°ãƒã‚¦ã‚¹ã®å‹•ãã«åˆã‚ã›ã¦ã†ã•ã¡ã‚ƒã‚“ã®ä½ç½®ã‚’æ›´æ–°
    usagiY = my - offsetY;
    drawScene();//é“ã‚„å®¶ãªã©ã®èƒŒæ™¯ã‚’å†æç”»
    drawUsagi(usagiX, usagiY);//æ›´æ–°ã—ãŸã†ã•ã¡ã‚ƒã‚“ã®ä½ç½®ã«ç”»åƒã‚’å†æç”»
  });

  //ãƒã‚¦ã‚¹ãŒå¤–ã‚ŒãŸã¨ãã‚‚ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼æ‰±ã„ã«
  canvas.addEventListener('mouseup', () => {//anvasä¸Šã§ãƒã‚¦ã‚¹ã®ãƒœã‚¿ãƒ³ã‚’é›¢ã—ãŸ(ã‚¯ãƒªãƒƒã‚¯ã‚’çµ‚ãˆãŸ)ç¬é–“ã«å‘¼ã°ã‚Œã‚‹å‡¦ç†ã‚’ç™»éŒ²
    if (!dragging) return;//ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ã„ãªã„çŠ¶æ…‹ãªã‚‰ä½•ã‚‚ã—ãªã„
    dragging = false;//ãƒ‰ãƒ©ãƒƒã‚°ã‚’çµ‚äº†(falseã«ã‚»ãƒƒãƒˆ)
    canvas.classList.remove('dragging');//CSSã§ä»˜ã‘ã¦ã„ãŸdraggingã‚¯ãƒ©ã‚¹ã‚’å¤–ã™(ã‚°ãƒ¼ã‹ã‚‰ãƒ‘ãƒ¼)
    stopSoundLoop(); //ãƒ‰ãƒ©ãƒƒã‚°çµ‚äº†æ™‚ã«éŸ³åœæ­¢
    if (//ã†ã•ã¡ã‚ƒã‚“ã®ç”»åƒãŒå®¶ã®ç¯„å›²å†…ã«ã‚ã‚‹ã‹ã‚’åˆ¤å®š(å…¨ã¦æº€ãŸã•ã‚Œã‚‹ã¨ã†ã•ã¡ã‚ƒã‚“ã¯å®¶ã®ä¸­ã«ã„ã‚‹)
      usagiX + usagiSize > houseX &&//ã†ã•ã¡ã‚ƒã‚“ã®å³ç«¯ãŒå®¶ã®å·¦ç«¯ã‚ˆã‚Šå³ã«ã‚ã‚‹ã‹
      usagiX < houseX + houseWidth &&//ã†ã•ã¡ã‚ƒã‚“ã®å·¦ç«¯ãŒå®¶ã®å³ç«¯ã‚ˆã‚Šå·¦ã«ã‚ã‚‹ã‹
      usagiY + usagiSize > houseY &&//ã†ã•ã¡ã‚ƒã‚“ã®ä¸‹ç«¯ãŒå®¶ã®ä¸Šç«¯ã‚ˆã‚Šä¸‹ã«ã‚ã‚‹ã‹
      usagiY < houseY + houseHeight//ã†ã•ã¡ã‚ƒã‚“ã®ä¸Šç«¯ãŒå®¶ã®ä¸‹ç«¯ã‚ˆã‚Šä¸Šã«ã‚ã‚‹ã‹
    ) {
      window.location.href = "/allclear";//ã†ã•ã¡ã‚ƒã‚“ãŒç„¡äº‹å®¶ã«å…¥ã£ãŸã®ã§ã™ã¹ã¦ã‚¯ãƒªã‚¢ç”»é¢ã¸ç§»å‹•
    } else {//ã‚‚ã—å®¶ã«å…¥ã£ã¦ã„ãªã‘ã‚Œã°
      window.location.href = "/continue";//ã‚²ãƒ¼ãƒ ã®continueç”»é¢ã«ç§»å‹•
    }
  });

  canvas.addEventListener('mouseleave', () => {//ãƒã‚¦ã‚¹ã‚«ãƒ¼ã‚½ãƒ«ãŒcanvasã®é ˜åŸŸã‹ã‚‰å¤–ã‚ŒãŸç¬é–“ã«å‘¼ã°ã‚Œã‚‹å‡¦ç†
    if (dragging) {//ç¾åœ¨ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã§ã‚ã‚Œã°æ¬¡ã®å‡¦ç†ã‚’å®Ÿè¡Œ
      dragging = false;//ãƒ‰ãƒ©ãƒƒã‚°ã‚’çµ‚äº†
      canvas.classList.remove('dragging');//CSSã®draggingã‚¯ãƒ©ã‚¹ã‚’å¤–ã™
      stopSoundLoop(); //ãƒã‚¦ã‚¹å¤–ã‚ŒãŸã‚‰éŸ³åœæ­¢
      window.location.href = "/continue";//ã‚²ãƒ¼ãƒ ã®continueç”»é¢ã«ç§»å‹•
    }
  });
</script>


</body>

</html>



<!-- ===============================

â˜…â˜…ã‚³ãƒ¡ãƒ³ãƒˆãªã—ã®ã‚³ãƒ¼ãƒ‰ãŒå¿…è¦ãªå ´åˆâ˜…â˜…
<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8" />
  <title>ã‚¹ãƒ†ãƒ¼ã‚¸4ï¼šã†ã•ã¡ã‚ƒã‚“ãŠå®¶ã¸å¸°ã‚‹</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link href="https://fonts.googleapis.com/css2?family=Yomogi&display=swap" rel="stylesheet">
  <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}">
  <style>
    #game-wrapper {
      margin-top: 20px;
    }

    #instructions {
      text-align: center;
      font-size: 18px;
      font-weight: bold;
      margin-top: 10px;
    }

    canvas {
      display: block;
      margin: 0 auto;

      border: none;
      cursor: grab;
    }

    canvas.dragging {
      cursor: grabbing;
    }
  </style>
</head>

<body>
  <h1>ã†ã•ã¡ã‚ƒã‚“ãŠå®¶ã¸å¸°ã‚‹</h1>
  <div id="instructions">é“ã‹ã‚‰ã¯ã¿å‡ºã•ãšã«ã†ã•ã¡ã‚ƒã‚“ã‚’ãŠå®¶ã¾ã§ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ãã ã•ã„ï¼ˆé›¢ã•ãªã„ã§ã­ğŸ°ï¼‰</div>
  <div id="game-wrapper">
    <canvas id="gameCanvas" width="800" height="600"></canvas>
  </div>
<script>
  const canvas = document.getElementById('gameCanvas');
  const ctx = canvas.getContext('2d');

  const michiImg = new Image();
  const houseImg = new Image();
  const usagiImg = new Image();
  const audio = new Audio("{{ url_for('static', filename='sounds/tokotoko.wav') }}"); // â† éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿
  audio.volume = 0.3; // â† ã“ã“ã§éŸ³é‡èª¿æ•´

  let soundInterval = null; // â† éŸ³å†ç”Ÿç”¨ã®ã‚¿ã‚¤ãƒãƒ¼ID

  michiImg.src = "{{ url_for('static', filename='images/michi.png') }}";
  houseImg.src = "{{ url_for('static', filename='images/house.png') }}";
  usagiImg.src = "{{ url_for('static', filename='images/usagi.png') }}";

  let imagesLoaded = 0;
  function onImageLoad() {
    imagesLoaded++;
    if (imagesLoaded === 3) {
      initGame();
    }
  }

  michiImg.onload = onImageLoad;
  houseImg.onload = onImageLoad;
  usagiImg.onload = onImageLoad;

  let usagiX = 710;
  let usagiY = 520;
  const usagiSize = 48;
  const houseX = 20;
  const houseY = 20;
  const houseWidth = 100;
  const houseHeight = 100;

  let dragging = false;
  let offsetX, offsetY;
  let pathPixels;

  function initGame() {
    ctx.drawImage(michiImg, 0, 0, canvas.width, canvas.height);
    pathPixels = ctx.getImageData(0, 0, canvas.width, canvas.height);
    drawScene();
    drawUsagi(usagiX, usagiY);
  }

  function drawScene() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.drawImage(michiImg, 0, 0, canvas.width, canvas.height);
    ctx.drawImage(houseImg, houseX, houseY, houseWidth, houseHeight);
  }

  function drawUsagi(x, y) {
    ctx.drawImage(usagiImg, x, y, usagiSize, usagiSize);
  }

  function isOnPath(x, y) {
    if (!pathPixels) return false;
    const px = Math.floor(x);
    const py = Math.floor(y);
    if (px < 0 || py < 0 || px >= canvas.width || py >= canvas.height) return false;
    if (
      x >= houseX &&
      x <= houseX + houseWidth &&
      y >= houseY &&
      y <= houseY + houseHeight
    ) {
      return true;
    }
    const idx = (py * canvas.width + px) * 4;
    const r = pathPixels.data[idx];
    const g = pathPixels.data[idx + 1];
    const b = pathPixels.data[idx + 2];
    return (r >= 250 && g >= 250 && b >= 250);
  }

  function startSoundLoop() {
    if (!soundInterval) {
      audio.play();
      soundInterval = setInterval(() => {
        audio.currentTime = 0;
        audio.play();
      }, 500);
    }
  }

  function stopSoundLoop() {
    clearInterval(soundInterval);
    soundInterval = null;
  }

  canvas.addEventListener('mousedown', (e) => {
    const rect = canvas.getBoundingClientRect();
    const mx = e.clientX - rect.left;
    const my = e.clientY - rect.top;
    if (mx >= usagiX && mx <= usagiX + usagiSize && my >= usagiY && my <= usagiY + usagiSize) {
      dragging = true;
      offsetX = mx - usagiX;
      offsetY = my - usagiY;
      canvas.classList.add('dragging');
      startSoundLoop();
    }
  });

  canvas.addEventListener('mousemove', (e) => {
    if (!dragging) return;
    const rect = canvas.getBoundingClientRect();
    const mx = e.clientX - rect.left;
    const my = e.clientY - rect.top;
    let newX = mx - offsetX + usagiSize / 2;
    let newY = my - offsetY + usagiSize / 2;

    if (!isOnPath(newX, newY)) {
      dragging = false;
      canvas.classList.remove('dragging');
      stopSoundLoop();
      window.location.href = "/continue";
      return;
    }

    usagiX = mx - offsetX;
    usagiY = my - offsetY;
    drawScene();
    drawUsagi(usagiX, usagiY);
  });

  canvas.addEventListener('mouseup', () => {
    if (!dragging) return;
    dragging = false;
    canvas.classList.remove('dragging');
    stopSoundLoop();
    if (
      usagiX + usagiSize > houseX &&
      usagiX < houseX + houseWidth &&
      usagiY + usagiSize > houseY &&
      usagiY < houseY + houseHeight
    ) {
      window.location.href = "/allclear";
    } else {
      window.location.href = "/continue";
    }
  });

  canvas.addEventListener('mouseleave', () => {
    if (dragging) {
      dragging = false;
      canvas.classList.remove('dragging');
      stopSoundLoop();
      window.location.href = "/continue";
    }
  });
</script>


</body>

</html>
=============================== -->